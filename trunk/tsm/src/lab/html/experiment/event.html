<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Time Space Map - Event </title>

<style type="text/css">
    @import url("../../../main/webapp/css/style.css");
	    
</style>


<script type="text/javascript" src="../../../main/webapp/javascript/map.js">
</script>
    

<script
			src="http://maps.google.com/maps?file=api&amp;v=2.x&amp;key=ABQIAAAA1DZDDhaKApTfIDHGfvo13hSQekddw1ZVY1OywWYSY7GTmNOxgRQ1UKcA9cKipDAZNLJ5R_X-JJcYhw"
			type="text/javascript">
		</script>		
		<script type="text/javascript">
		//<![CDATA[
	function saveEvent() {
		document.getElementById("eventForm").lat.value = marker.getLatLng().lat();
		document.getElementById("eventForm").lng.value = marker.getLatLng().lng();
		document.getElementById("eventForm").zoomLevel.value = map.getZoom();
		document.event.submit();
	}			

	/*
		Called by the main initialize function
	 */
	function initialize() {
			initializeMap();
			var editLocation = false;
			if (document.getElementById("eventForm").lat.value != "") {
				editLocation = true;
			}
			if (editLocation) {
				var zoomStr = document.getElementById("eventForm").zoomLevel.value;
				var zoom;
				if (zoomStr == '') {
					zoom = 11;
				} else {
					zoom = parseInt (zoomStr);
				}
				map.setCenter(new GLatLng(
					document.getElementById("eventForm").lat.value,
					document.getElementById("eventForm").lng.value), zoom); 
			} else {
				//TODO UI WORK: don't have a default starting point
				map.setCenter(new GLatLng(40.879721,-76.998322),11);  //la la land, PA 
			}
			//Add a marker in the center of the map		
			var point = map.getCenter();
			marker = new GMarker(point, {draggable: true});
			map.addOverlay(marker);
			marker.enableDragging();
				marker.openInfoWindowHtml("<b>Drag me</b> <br/>anywhere on the map");
/*			if (!editLocation) {
				marker.openInfoWindowHtml("<b>Drag me</b> <br/>anywhere on the map");
			}
	*/
			GEvent.addListener(marker, "dragstart", function() {
				map.closeInfoWindow();
			});
		
			GEvent.addListener(marker, "click", function() {
				marker.openInfoWindowHtml(html);
			});		
			
			adjustSidebarIE();
			
			drawPlacemarks();
		}
	
	// addAddressToMap() is called when the geocoder returns an
	// answer.  
	function addAddressToMap(response) {
	  if (!response || response.Status.code != 200) {
	    alert("Sorry, we can't find that location, " + response.Status.code);
	  } else {
	    place = response.Placemark[0];
	    point = new GLatLng(place.Point.coordinates[1],
	                        place.Point.coordinates[0]);
				map.setCenter(point, 13);
				marker.setLatLng(point);
	    marker.openInfoWindowHtml(place.address + '<br>' + '<br/><b>Drag me</b> anywhere on the map');
	  }
	}
	
	// showAddress() is called when you click on the Search button
	// in the form.  It geocodes the address entered into the form
	// and adds a marker to the map at that location.
	function showAddress(address) {
	    geocoder.getLocations(address, addAddressToMap);
	}
	
	
		// Create a base icon for all of our markers that specifies the
	// shadow, icon dimensions, etc.
	var baseIcon = new GIcon();
	baseIcon.shadow = "http://www.google.com/mapfiles/shadow50.png";
	baseIcon.iconSize = new GSize(20, 34);
	baseIcon.shadowSize = new GSize(37, 34);
	baseIcon.iconAnchor = new GPoint(9, 34);
	baseIcon.infoWindowAnchor = new GPoint(9, 2);
	baseIcon.infoShadowAnchor = new GPoint(18, 25);
		
	function drawPlacemarks() {
			var eventsJSON2 = document.getElementById("eventForm").searchResults.value;
			var events = eventsJSON2.parseJSON();
			alert("sdf");  //TODO DEBUG the parseJSON isn't working!!! and remove cut and paste too!
			
			//create the markers
			for (var i =0; i<events.length; i++) {
  			alert("sdf");
			  map.addOverlay( createMarker(events[i]) );
			} 
	}

	function createMarker(event) {
			  // Create a lettered icon for this point using our icon class
			  var letter = String.fromCharCode("A".charCodeAt(0) + markerIndex);
			  var letteredIcon = new GIcon(baseIcon);
			  letteredIcon.image = "http://www.google.com/mapfiles/marker" + letter + ".png";
			
			  // Set up our GMarkerOptions object
			  markerOptions = { icon:letteredIcon };
				var marker = new GMarker(new GLatLng(event.latLng.lat, event.latLng.lng));

				var html = '<b>' + event.summary+'</b><br/>' + event.when + '<br/>' +
				event.description + '<br/>' +
				'<br/><b>Tags: </b>' + event.tags + '<br/>' + 
				'<b>Source: </b>' + event.source + '<br/>' + 
				'<a href="/event.htm?listid=' + event.id + '">edit</a>' +  
				' &nbsp; <a href="#">flag</a><br/>'
				;
				//save this marker.
				markers[markerIndex] = marker;
				markerHtml[markerIndex] = html;
				markerIndex++;

				marker.bindInfoWindowHtml(html);

				return marker;
	}
	
	function changeHistory() {
		var id = document.getElementById("eventForm").id.value;
		if (id != '') {
			document.location="changehistory.htm?id=" + id;
		}
	}
	
	function adjustSidebarIE() {
		var top = document.getElementById("sidebar").offsetTop;
		var hght=document.documentElement.clientHeight-top-25;
		
		mapLeft = document.getElementById("edittable").clientWidth + 10;
		document.getElementById("map").style.left=mapLeft + "px";
		
		document.getElementById("eventForm").style.height=hght+"px";
	}

  function changeAlert() { //????????????????
		alert("sdfgsf");
	}
			
		//]]>
		</script>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Pragma" content="no-cache">
</head>

<body onload="initialize()" onunload="GUnload();" class="mapedit" onresize="adjustSidebarIE();"  onchange="changeAlert();">

	

<div id="nav">
<ul>
<li><a href="/tsm">Home</a></li
><li><a href="#">Logout</a></li
></ul>
</div>
	



  <div id="head">
		<table style="width:100%">
    	<tr>
      	<td width="125">
			    <img src="../images/logo.png" alt="" />

        </td>
        <td>
			    <img style="float: right" src="../images/banner-timeline.png" alt="" width="506" height="63" />
        </td>
      </tr>
    </table>    	
  </div>

  
  <table><tr><td>
	<div id="content">
	   <div id="sidebar">

       <form id="eventForm" name="event" method="post" action="/tsm/event.htm" onsubmit="saveEvent(); return false">
			   <input id="id" name="id" type="hidden" value=""/>
			   <input id="lat" name="lat" type="hidden" value=""/>
			   <input id="lng" name="lng" type="hidden" value=""/>
			   <input id="zoomLevel" name="zoomLevel" type="hidden" value=""/>
			   <input id="searchResults" name="searchResults" type="hidden" value=""/>
				 <div class="topMiniTab" style="margin-bottom:5px; margin-left:5px">
					 <span class="selectedMiniTab">Edit</span><a class="unselectedMiniTab" href="#" onclick="changeHistory(); return false;">Change History</a>
	       </div>
         <table id="edittable" >
           <tr>
             <td class="labelcell">Summary <br/>
             <input id="summary" name="summary" type="text" value="" size="45"/></td>
           </tr>
           <tr>
             <td class="labelcell">Where
                 <small>e.g., "gettysburg, pa" </small><br/>

                 <input id="where" name="where" type="text" value="" size="45"/>
                 <br/>
                 <input  type="button" name="Find" value="Go to Location" onclick="showAddress(document.event.where.value); return false"/>             
                 <small id="tip"><b>Tip:</b> drag and drop the lollypop!</small>
             </td>
           </tr>
           <tr>
             <td class="labelcell">

               When
               <small>
                 e.g. "1962" or "March, 1064" or "1880 - 1886" <a href="#">hints</a>
               </small><br/>
               <input id="when" name="when" type="text" value="" size="45"/>
             </td>
           </tr>
           <tr>

             <td class="labelcell">Description<br/>
             <textarea id="description" name="description" rows="5" cols="35"></textarea></td>
           </tr>
           <tr>
             <td class="labelcell">Tags<br/>
	             <input id="tags" name="tags" type="text" value="" size="45"/>
             </td>

           </tr>
           <tr>
             <td class="labelcell">Source 
             <small><a class="selectedMiniTab" href="#">URL</a><a class="unselectedMiniTab" href="#">Publication</a><a class="unselectedMiniTab" href="#">Other</a></small><br/>
             <input id="source" name="source" type="text" value="" size="45"/>
           </td> 
             
           </tr>
         </table>

         <input type="submit" name="Save" value="Save This Event" />
         <input type="button" name="Cancel" value="Cancel" onclick="javascript:document.location='eventsearch.htm';"/>
	     </form>
	   </div>
    
    
	   <div id="map"  style="position:absolute; height:1000px;width:1000px">
	     Map coming...
	     <noscript>
	       <p>
	         JavaScript must be enabled to get the map.
	       </p>
	     </noscript>
	   </div>
	</div>
  </td></tr></table>

  <div >
	  <hr/>
	  <div id="clearFloat"/>  
		Time Space Map
  </div>
  </body>
</html>
